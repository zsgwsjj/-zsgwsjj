---
title: Mysql
date: 2019-10-24 16:01:20
type: "Mysql"
---

### MVCC(Multi Version Concurrency Control)多版本并发控制

* 相对的是基于锁的并发控制(Lock-Based Concurrency Control)
* 最大优势：
    * 读不加锁所以读写不冲突
* 实现原理
    * 基于`undo log`
    * 通过回滚段来构建所需的版本
    * 通过`ReadView`来判断哪些版本的数据可见
    * `Purge`线程通过`ReadView`来清理旧版本
    
#### Mysql事务日志
* 可以提高事务的效率
* 事务日志采用追加的方式，顺序I/O操作
* 称之为预写式日志
* `Undo Log`
    * 保证原子性，异常发生之后对已执行的操作进行回滚
    * 所有修改先记录该日志，再进行数据的写入
* `Redo Log`
    * 实现事务的持久性
    * 由内存中的重做日志缓冲区（易失）和磁盘上的重做日志文件组成（持久）
    * 实现步骤：
        ![Redo Log步骤示意图](/images/redolog.png)
    * 以`512`字节的块的形式进行存储，与磁盘扇区大小相同，保证原子性，避免断电导致重做日志仅写入一部分并留下脏数据
* 保证了两点：
    * 发生错误或者需要拍回滚的事务能够成功回滚（原子性）    
    * 在事务提交之后，数据没来得及写入磁盘就宕机时，在下次重新启动后能够恢复数据（持久性）

#### Mysql Server日志
* server层维护，`bin log`
* 一种二进制日志
* 与`redo log`和`undo log`完全不同
* 主要记录mysql数据更新或潜在更新的sql语句，并以"事务"的形式保存在磁盘中
* 作用主要有：
    * 复制：MySQL Replication 在 Master 端开启 binlog ，Master 把它的二进制日志传递给 slaves 并回放来达到 master-slave 数据一致的目的
    * 数据恢复：通过 mysqlbinlog 工具恢复数据
    * 增量备份

#### Buffer Pool
* 缓存包括：
    * 索引页
    * 数据页
    * undo页
    * 插入缓冲
    * 自适应哈希索引
    * innodb储存的锁信息
    * 数据字典

#### MVCC实现
* 在每行记录后面保存两个隐藏的列
* 一个保存了行的创建时间，一个保存行的过期时间（或删除时间）
* 非实际时间，而是版本号
* 没开始新事务，版本号递增
* 事务开始时刻的版本号会作为事务的版本号，用来和每行查询到的每行记录的版本号进行对比
* `Repeatable Read`隔离级别下，MVCC具体操作：
    * `SELECT`
        * 查找版本小于等于当前事务版本的数据行
        * 查找删除版本大于当前实物版本的数据行
    * `INSERT`
        * 为新插入的每一行保存当前系统版本号作为行版本号
    * `DELETE`
        * 为删除的每一行保存当前系统版本号作为删除标识
    * `UPDATE`
        * 插入一条新纪录，保存当前版本号为行版本号
        * 保存当前系统版本号到原来行作为删除标识

### 主从同步
* 可解决的问题
    * 高可用
    * 负载均衡
    * 数据备份
    * 业务模块化
    * 高扩展
        * `scale-up`：向上扩展或者纵向扩展，主要是提供比现在服务器更好性能的服务器，比如增加CPU和内存以及磁盘阵列等，因为有多台服务器，所以可扩展性比单台腾大
        * `scale-out`: 向外扩展或者横向扩展，是指增加服务器数量的扩展，这样主要能分散各个服务器的压力
* 缺点
    * 成本增加
    * 数据延迟
    * 写入更慢

* 如何解决主从延时
    * 半同步复制
        * `semi-sync`复制
        * 主库写入`binglog`之后,强制立即进行数据同步
        * 从库写入`relay log`之后，返回ack给主库
        * 主库接受到至少一个ack之后才认为操作完成
    * 并行复制
        * 从库开启多个线程并行读取`reloy log`中不同库的日志，然后并行重放   

* 复制原理
    * master --> binlog(二进制日志事件binary log events)
    * slave --> I/O 读取 binlog(master) --> relay log
    * slave 重做 relay log中的事件，依次执行，也即是数据重放
    * ![主从同步示意图](/images/mysql主从同步原理.png)

* 主从同步要求
    * 主从服务器操作系统版本和位数一致
    * 主从数据库版本一致
    * 主从数据库中数据一致
    * master开启二进制日志，master和slave的server_id在局域网内部必须唯一

### 分库、扩容时的数据迁移
* 分库分表
    * 避免两个问题
        * 数据迁移
        * 热点
